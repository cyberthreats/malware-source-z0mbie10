
MAXKEY                  equ     256

include                 consts.inc

callW                   macro   _xxx
                        extrn   _xxx:proc
                        call    _xxx
                        endm

                        p386
                        model   flat
                        locals  __
                        jumps

                        .data

msg1                    db      'þ data loaded ok',13,10,0
resptr                  dd      msg2
                        dd      msg3
msg2                    db      'þ normal file',13,10,0
msg3                    db      'þ *** SIGNATURE OK ***',13,10,0
msg4                    db      'syntax: DETECT filename',13,10,0
msg5                    db      'invalid file name',13,10,0

                        align   4

rsa_d:
dd 06FC1339Bh
dd 067D18E5Bh
dd 02AA7BDC5h
dd 035C8C94Ch
dd 0,0,0,0

rsa_n:
dd 0CBDE37DBh
dd 07C67176Dh
dd 02EF1A83Bh
dd 0B4DF16A5h
dd 0,0,0,0

rsa_x                   dd      8 dup (0)
rsa_y                   dd      8 dup (0)

argc                    dd      ?
argv0                   db      256 dup (?)
argv1                   db      256 dup (?)
argv2                   db      256 dup (?)
argv3                   db      256 dup (?)

                        .code
start:
                        call    getcmdline

                        cmp     argc, 2
                        jne     help

                        lea     edx, argv1
                        call    fopen_ro
                        jc      err1
                        xchg    ebx, eax
                        call    fgetsize
                        lea     edx, [eax-16]
                        call    fseek
                        lea     edx, rsa_x
                        mov     ecx, 16
                        call    fread
                        cmp     eax, 16
                        jne     err1
                        call    fclose

                        lea     edx, msg1
                        call    dump_asciiz_edx

                        push    256             ; keylen, in BITs
                        push    offset rsa_x    ; base
                        push    offset rsa_y    ; result
                        push    offset rsa_d    ; exponent
                        push    offset rsa_n    ; modulus
                        call    rsa_main

                        mov     eax, rsa_y.dword ptr 0
                        xor     eax, rsa_y.dword ptr 4
                        xor     eax, rsa_y.dword ptr 8
                        xor     eax, rsa_y.dword ptr 12
                        cmp     eax, -'Z0MB'
                        sete    al
                        movzx   eax, al
                        mov     edx, resptr[eax*4]
                        call    dump_asciiz_edx

exit:                   push    -1
                        callW   ExitProcess

help:                   lea     edx, msg4
                        call    dump_asciiz_edx
                        jmp     exit

err1:                   lea     edx, msg5
                        call    dump_asciiz_edx
                        jmp     exit

include                 cmdline.inc
include                 fioexlow.inc
include                 console.inc
include                 rsalib1.inc

                        end     start
