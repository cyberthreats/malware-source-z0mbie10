
IFDEF   USE_SIGN

; build signature

buildsign:              pusha

                        mov     edi, [ebp].v_bufptr

                        mov     esi, 16

__cycle:                push    256
                        push    ebp
                        call    my_random
                        add     esp, 8

                        xor     [edi+esi-1], al

                        dec     esi
                        jnz     __cycle

                        and     byte ptr [edi+15], 3Fh ; clear highest 2 bits

                        mov     eax, [edi+12]
                        xor     eax, [edi+8]
                        xor     eax, [edi+4]
                        xor     eax, -'Z0MB'
                        mov     [edi+0], eax

                        push    0B4DF16A5h      ; N, reversed order
                        push    02EF1A83Bh
                        push    07C67176Dh
                        push    0CBDE37DBh
                        mov     esi, esp

                        mov     eax, 50003

                        call    modexp55        ; *EDI = (*EDI ^ EAX) % *ESI

                        add     esp, 16

                        mov     [ebp].v_bufsize, 16

                        popa
                        retn

ENDIF ; USE_SIGN
